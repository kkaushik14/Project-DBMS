<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Edit Issued Books</title>
  <link href="./output.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <nav class="bg-gray-800 py-4 px-6 flex justify-between items-center">
    <span class="text-2xl font-bold text-blue-300">ðŸ“š LMS Admin</span>
    <a href="index.html" class="text-blue-400 hover:underline">Back to Dashboard</a>
  </nav>
  <main class="flex-1 container mx-auto py-8">
    <h1 class="text-3xl font-extrabold mb-8 text-blue-300 text-center tracking-wide drop-shadow-lg" style="letter-spacing: 0.05em;">Edit/Delete Issued Books</h1>
    <div id="issued-books-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
  </main>
  <script>
    const API_BASE_URL = 'http://localhost:1954';
    async function fetchIssuedBooks() {
      const res = await fetch(`${API_BASE_URL}/api/admin/issued-books`);
      const books = await res.json();
      const list = document.getElementById('issued-books-list');
      list.innerHTML = books.map(b => `
        <form class="bg-blue-950 border-4 border-blue-400 rounded-2xl shadow-xl p-6 flex flex-col gap-3 issued-edit-form" data-id="${b.id}">
          <div class="flex flex-col gap-2 mb-2">
            <div class="flex items-center gap-2">
              <span class="text-blue-200 font-semibold">Student Name:</span>
              <input type="text" name="name" value="${b.student_name || ''}" class="auth-input flex-1" required />
            </div>
            <div class="flex items-center gap-2">
              <span class="text-blue-200 font-semibold">Payment (â‚¹):</span>
              <input type="number" name="payment" value="${b.payment}" class="auth-input flex-1" required />
            </div>
            <div class="flex items-center gap-2">
              <span class="text-blue-200 font-semibold">Return Date:</span>
              <input type="date" name="return_date" value="${b.return_date ? b.return_date.split('T')[0] : ''}" class="auth-input flex-1" required />
            </div>
          </div>
          <div class="flex gap-4 mt-2">
            <button type="submit" class="auth-btn bg-gradient-to-r from-green-600 to-green-400 hover:from-green-700 hover:to-green-500">Update</button>
            <button type="button" class="auth-btn bg-gradient-to-r from-red-600 to-red-400 hover:from-red-700 hover:to-red-500 delete-btn">Delete</button>
          </div>
          <div class="text-xs text-blue-300 mt-2">Book ID: <span class="font-semibold">${b.book_id}</span> | Issued: <span class="font-semibold">${b.issued_date}</span></div>
          <div class="update-status text-xs mt-1"></div>
        </form>
      `).join('');
      setupEditDeleteHandlers();
    }

    function setupEditDeleteHandlers() {
      document.querySelectorAll('.issued-edit-form').forEach(form => {
        const id = form.getAttribute('data-id');
        form.onsubmit = async function(e) {
          e.preventDefault();
          const name = form.name.value;
          const payment = form.payment.value;
          const return_date = form.return_date.value;
          const status = form.querySelector('.update-status');
          status.textContent = 'Updating...';
          const res = await fetch(`${API_BASE_URL}/api/admin/issued-books/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, payment, return_date })
          });
          const result = await res.json();
          status.textContent = result.message || (res.ok ? 'Updated!' : 'Update failed.');
        };
        form.querySelector('.delete-btn').onclick = async function() {
          if (!confirm('Are you sure you want to delete this issued book record?')) return;
          const status = form.querySelector('.update-status');
          status.textContent = 'Deleting...';
          const res = await fetch(`${API_BASE_URL}/api/admin/issued-books/${id}`, { method: 'DELETE' });
          const result = await res.json();
          status.textContent = result.message || (res.ok ? 'Deleted!' : 'Delete failed.');
          if (res.ok) {
            setTimeout(fetchIssuedBooks, 1000);
          }
        };
      });
    }

    fetchIssuedBooks();
  </script>
</body>
</html>
